<!DOCTYPE html>
<html lang="th" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Production Insights | Nov 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-main: #f1f5f9;
            --card-bg: #ffffff;
            --card-border: #e2e8f0;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --accent-primary: #3b82f6;
            --glass-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.1);
            --sub-card-bg: #f8fafc;
        }

        [data-theme="dark"] {
            --bg-main: #0f172a;
            --card-bg: #1e293b;
            --card-border: #334155;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --accent-primary: #60a5fa;
            --glass-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --sub-card-bg: rgba(30, 41, 59, 0.5);
        }

        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
            overflow-x: hidden;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* --- CARDS & UI --- */
        .glass-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--glass-shadow);
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            display: flex;
            flex-direction: column;
        }
        .glass-card:hover {
            box-shadow: 0 12px 24px -4px rgba(0, 0, 0, 0.15);
            border-color: var(--text-sub);
        }

        .info-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--glass-shadow);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .sub-card {
            background-color: var(--sub-card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 16px;
        }

        /* Grid System */
        .grid-12 { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; margin-bottom: 24px; }
        .col-span-2 { grid-column: span 2; }
        .col-span-3 { grid-column: span 3; }
        .col-span-4 { grid-column: span 4; }
        .col-span-8 { grid-column: span 8; }
        .col-span-9 { grid-column: span 9; }
        .col-span-12 { grid-column: span 12; }

        @media (max-width: 1280px) {
            .col-span-2, .col-span-4 { grid-column: span 6; }
            .col-span-8, .col-span-9, .col-span-3 { grid-column: span 12; }
            .grid-12 { grid-template-columns: repeat(12, 1fr); }
        }
        @media (max-width: 768px) {
            .col-span-2, .col-span-4, .col-span-6 { grid-column: span 12; }
        }

        /* Typography */
        .kpi-value {
            font-family: 'Inter', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin: 10px 0;
            background: -webkit-linear-gradient(45deg, #334155, #64748b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        [data-theme="dark"] .kpi-value {
            background: -webkit-linear-gradient(45deg, #fff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .kpi-label { color: var(--text-sub); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        
        /* Secondary Metric Typography */
        .sec-label { font-size: 0.8rem; color: var(--text-sub); font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .sec-value { font-family: 'Inter', sans-serif; font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .sec-sub { font-size: 0.75rem; color: var(--text-sub); margin-top: 2px; }

        /* Trend Badges */
        .trend-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
        }
        .trend-up { background: rgba(74, 222, 128, 0.15); color: #16a34a; }
        [data-theme="dark"] .trend-up { color: #4ade80; }
        .trend-down { background: rgba(248, 113, 113, 0.15); color: #dc2626; }
        [data-theme="dark"] .trend-down { color: #f87171; }

        /* Tabs */
        .tab-nav {
            display: flex;
            background: var(--bg-main);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            gap: 4px;
        }
        .tab-btn {
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-sub);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .tab-btn.active { background: var(--card-bg); color: var(--accent-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--card-border); }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Tables */
        .table-container { overflow-x: auto; overflow-y: auto; }
        .h-table-fixed { height: 300px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.9rem; }
        th { 
            text-align: left; padding: 12px; color: var(--text-sub); font-weight: 600; 
            border-bottom: 2px solid var(--card-border); 
            position: sticky; top: 0; background: var(--card-bg); z-index: 10; 
        }
        td { padding: 10px 12px; border-bottom: 1px solid var(--card-border); color: var(--text-main); vertical-align: middle; }
        tr:hover td { background-color: rgba(255,255,255,0.03); }
        [data-theme="light"] tr:hover td { background-color: rgba(0,0,0,0.03); }

        /* Chart Containers */
        .chart-box { position: relative; width: 100%; height: 350px; }
        .chart-box-detail { position: relative; width: 100%; height: 300px; }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 navbar">
            <div class="flex items-center gap-4">
                <div class="relative w-12 h-12 flex items-center justify-center">
                    <div class="absolute inset-0 bg-blue-500 rounded-xl blur opacity-20"></div>
                    <div class="relative w-full h-full bg-gradient-to-tr from-slate-800 to-slate-900 rounded-xl border border-slate-700 flex items-center justify-center text-blue-400 text-2xl shadow-inner">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                </div>
                <div>
                    <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 leading-tight">
                        Smart Production Insights
                    </h1>
                    <p class="text-[var(--text-sub)] text-sm font-medium mt-0.5">Egg Grading Performance • November 2025</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <span class="px-4 py-2 rounded-lg sub-card text-sm text-[var(--text-sub)] hidden md:block">
                    <i class="fa-solid fa-server mr-2 text-green-500"></i>Online
                </span>
                <div class="tab-nav">
                    <div class="tab-btn active" onclick="switchTab('overview')">Overview</div>
                    <div class="tab-btn" onclick="switchTab('details')">Details</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleTheme()" id="themeBtn" class="w-10 h-10 rounded-xl border border-[var(--card-border)] bg-[var(--bg-main)] text-[var(--text-sub)] hover:text-[var(--text-main)] flex items-center justify-center transition-colors shadow-sm">
                        <i class="fa-solid fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- === VIEW: OVERVIEW === -->
        <div id="view-overview" class="tab-content active">
            
            <!-- 1. KPI Grid -->
            <div class="grid-12">
                <!-- OEE (Large Card) -->
                <div class="glass-card col-span-4 flex flex-col justify-between relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                        <i class="fa-solid fa-gauge-high text-8xl text-[var(--text-main)]"></i>
                    </div>
                    <div>
                        <div class="kpi-label">OEE (Overall Equipment Effectiveness)</div>
                        <div class="kpi-value" id="kpi-oee">0%</div>
                        <div id="kpi-oee-comp"></div>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 h-2 rounded-full mt-4 overflow-hidden">
                        <div id="oee-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Availability -->
                <div class="glass-card col-span-2">
                    <div class="kpi-label text-cyan-500 mb-1"><i class="fa-solid fa-clock mr-1"></i> Availability</div>
                    <div class="kpi-value text-2xl" id="kpi-a">0%</div>
                    <div id="kpi-a-comp" class="text-sm mt-auto"></div>
                </div>

                <!-- Performance -->
                <div class="glass-card col-span-2">
                    <div class="kpi-label text-amber-500 mb-1"><i class="fa-solid fa-bolt mr-1"></i> Performance</div>
                    <div class="kpi-value text-2xl" id="kpi-p">0%</div>
                    <div id="kpi-p-comp" class="text-sm mt-auto"></div>
                </div>

                <!-- Quality -->
                <div class="glass-card col-span-2">
                    <div class="kpi-label text-green-500 mb-1"><i class="fa-solid fa-check-circle mr-1"></i> Quality</div>
                    <div class="kpi-value text-2xl" id="kpi-q">0%</div>
                    <div id="kpi-q-comp" class="text-sm mt-auto"></div>
                </div>

                <!-- Speed -->
                <div class="glass-card col-span-2">
                    <div class="kpi-label text-purple-500 mb-1"><i class="fa-solid fa-box mr-1"></i> Prod/Hr</div>
                    <div class="kpi-value text-2xl" id="kpi-prod">0</div>
                    <div id="kpi-prod-comp" class="text-sm mt-auto"></div>
                </div>
            </div>

            <!-- 2. Content Grid (Chart & Summary) -->
            <div class="grid-12">
                <!-- Left: OEE Trend Chart -->
                <div class="glass-card col-span-8">
                    <div class="card-title mb-4">
                        <i class="fa-solid fa-chart-area text-blue-500"></i> แนวโน้มประสิทธิภาพรายวัน
                    </div>
                    <div class="chart-box">
                        <canvas id="chartOEE"></canvas>
                    </div>
                </div>

                <!-- Right: Production Summary -->
                <div class="glass-card col-span-4 flex flex-col gap-4">
                    <div class="card-title mb-2"><i class="fa-solid fa-box-open text-emerald-500"></i> สรุปยอดการผลิต</div>
                    
                    <div class="sub-card flex justify-between items-center">
                        <div>
                            <div class="text-[var(--text-sub)] text-xs uppercase font-bold">Total Eggs</div>
                            <div class="text-2xl font-bold text-[var(--text-main)] font-['Inter']" id="kpi-total-eggs">0</div>
                        </div>
                        <div id="kpi-total-eggs-comp" class="text-right"></div>
                    </div>

                    <div class="sub-card flex justify-between items-center">
                        <div>
                            <div class="text-[var(--text-sub)] text-xs uppercase font-bold">Total Defects</div>
                            <div class="text-2xl font-bold text-red-500 font-['Inter']" id="kpi-total-defect">0</div>
                        </div>
                        <div id="kpi-total-defect-comp" class="text-right"></div>
                    </div>

                    <div class="sub-card">
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-[var(--text-sub)] text-xs uppercase font-bold">Defect Rate</div>
                            <div class="text-2xl font-bold text-[var(--text-main)] font-['Inter']" id="kpi-defect-rate">0%</div>
                        </div>
                        <div class="w-full bg-slate-200 dark:bg-slate-700 h-1.5 rounded-full">
                            <div id="defect-bar" class="h-full bg-red-500 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VIEW: DETAILS === -->
        <div id="view-details" class="tab-content">
            
            <!-- NEW: Supplementary Info Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- 1. Avg Finish Time -->
                <div class="info-card">
                    <div class="sec-label"><i class="fa-solid fa-hourglass-end text-blue-500"></i> เวลาเลิกงานเฉลี่ย</div>
                    <div class="sec-value" id="det-avg-finish">--:--</div>
                    <div class="sec-sub">Finish Time</div>
                </div>
                <!-- 2. Avg Operation Time -->
                <div class="info-card">
                    <div class="sec-label"><i class="fa-solid fa-business-time text-purple-500"></i> ชม.ทำงานเฉลี่ย/วัน</div>
                    <div class="sec-value" id="det-avg-op">00:00:00</div>
                    <div class="sec-sub" id="det-avg-op-count">จาก Oparation Time</div>
                </div>
                <!-- 3. Max Finish Time -->
                <div class="info-card">
                    <div class="sec-label"><i class="fa-solid fa-clock-rotate-left text-red-500"></i> เลิกงานช้าที่สุด</div>
                    <div class="sec-value" id="det-max-finish">--:--</div>
                    <div class="sec-sub text-red-400 font-semibold" id="det-max-finish-date">-</div>
                </div>
                <!-- 4. Avg Eggs & Defect -->
                <div class="info-card">
                    <div class="sec-label"><i class="fa-solid fa-egg text-yellow-500"></i> ค่าเฉลี่ยต่อวัน</div>
                    <div class="flex justify-between items-end mt-1">
                        <div>
                            <div class="text-2xl text-[var(--text-main)] font-bold font-['Inter']" id="det-avg-egg">0</div>
                            <div class="text-xs text-[var(--text-sub)]" id="det-avg-egg-count">ฟอง</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl text-red-400 font-bold font-['Inter']" id="det-avg-def">0</div>
                            <div class="text-xs text-[var(--text-sub)]" id="det-avg-def-count">เสีย</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grid: Charts (Speed & Coop) -->
            <div class="grid-12">
                <div class="glass-card col-span-8">
                    <div class="flex justify-between items-center mb-4">
                        <div class="card-title mb-0"><i class="fa-solid fa-bolt text-yellow-500"></i> Speed vs Loss Correlation</div>
                    </div>
                    <div class="chart-box-detail">
                        <canvas id="chartSpeedLoss"></canvas>
                    </div>
                </div>

                <div class="glass-card col-span-4">
                    <div class="card-title mb-2"><i class="fa-solid fa-stopwatch text-purple-500"></i> Avg. Time per Coop</div>
                    <div class="chart-box-detail">
                        <canvas id="chartCoop"></canvas>
                    </div>
                    <div id="badge-eff" class="mt-3 text-center text-sm font-mono text-[var(--text-sub)] sub-card border-none bg-blue-500/10 text-blue-400"></div>
                </div>
            </div>

            <!-- Grid: Tables (Data & Loss) -->
            <div class="grid-12">
                <!-- Full Table -->
                <div class="glass-card col-span-8">
                    <div class="card-title mb-4"><i class="fa-solid fa-table-cells text-blue-500"></i> Daily Production Log</div>
                    <div class="table-container h-table-fixed">
                        <table id="table-full-el">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th class="text-center text-blue-400">Time</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-right">Speed</th>
                                    <th class="text-right">Total</th>
                                    <th class="text-right">Defect</th>
                                    <th class="text-center">Loss</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody id="table-full"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Loss Analysis -->
                <div class="glass-card col-span-4">
                    <div class="card-title mb-4"><i class="fa-solid fa-triangle-exclamation text-orange-500"></i> Loss Analysis</div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center p-3 sub-card rounded-lg">
                            <div class="text-orange-500 text-2xl font-bold font-['Inter']" id="kpi-total-loss">0</div>
                            <div class="text-xs text-[var(--text-sub)]">เวลาหยุดรวม (ชม.)</div>
                        </div>
                        <div class="text-center p-3 sub-card rounded-lg">
                            <div class="text-purple-500 text-2xl font-bold font-['Inter']" id="kpi-total-events">0</div>
                            <div class="text-xs text-[var(--text-sub)]">จำนวนครั้ง</div>
                        </div>
                    </div>

                    <div class="table-container h-[200px]">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="width: 20%;">Date</th>
                                    <th>Cause</th>
                                    <th style="width: 20%; text-align: right;">Hr</th>
                                </tr>
                            </thead>
                            <tbody id="table-loss-top"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let charts = {};
        let rawData = [];

        // --- UI FUNCTIONS ---
        function switchTab(viewId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const idx = viewId === 'overview' ? 0 : 1;
            document.querySelectorAll('.tab-btn')[idx].classList.add('active');

            setTimeout(() => { Object.values(charts).forEach(c => c && c.resize()); }, 50);
        }

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateChartColors(newTheme);
            
            const btn = document.getElementById('themeBtn');
            btn.innerHTML = newTheme === 'light' ? '<i class="fa-solid fa-sun text-yellow-500"></i>' : '<i class="fa-solid fa-moon"></i>';
        }

        function updateChartColors(theme) {
            const grid = theme === 'dark' ? '#334155' : '#e2e8f0';
            const text = theme === 'dark' ? '#94a3b8' : '#64748b';
            Chart.defaults.color = text;
            Chart.defaults.borderColor = grid;
            Object.values(charts).forEach(c => {
                if (c) {
                    c.options.scales.y.grid.color = grid;
                    if(c.options.scales.x) c.options.scales.x.grid.display = false;
                    c.update('none');
                }
            });
        }

        // --- UTILS ---
        function animateValue(obj, start, end, duration, formatter = (v)=>v) {
            if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const displayVal = progress * (end - start) + start;
                obj.innerHTML = formatter(displayVal);
                if (progress < 1) window.requestAnimationFrame(step);
                else obj.innerHTML = formatter(end);
            };
            window.requestAnimationFrame(step);
        }
        function setHtml(id, val) { const el = document.getElementById(id); if(el) el.innerHTML = val; }
        function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }

        // --- TIME HELPER ---
        function timeToSecs(t) {
            if(!t) return 0;
            const p = t.split(':').map(Number);
            return (p[0]||0)*3600 + (p[1]||0)*60 + (p[2]||0);
        }
        function secsToTime(s) {
            const h = Math.floor(s/3600);
            const m = Math.floor((s%3600)/60);
            const sec = Math.round(s%60);
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
        }
        function timeToMins(t) { return timeToSecs(t)/60; }
        function minsToTime(m) {
            const h = Math.floor(m/60);
            const min = Math.round(m % 60);
            return `${String(h).padStart(2,'0')}:${String(min).padStart(2,'0')}`;
        }
        
        function decimalHoursToHM(val) {
             const h = Math.floor(val);
             const m = Math.round((val - h) * 60);
             return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')} ชม.`;
        }

        // --- DATA ---
        async function init() {
            const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRlpC6mhBM2bPVYgz5pS6PAIW9Brzs6GAOH0wwFpfxB6eK_L5InKpqIcSusdOlRSLZ0swhFlqBiysx8/pub?gid=565758569&single=true&output=csv';
            try {
                const res = await fetch(url);
                const txt = await res.text();
                processData(txt);
            } catch(e) { console.error("Data Load Error:", e); }
        }

        function processData(csv) {
            const lines = csv.trim().replace(/\r/g,"").split('\n');
            const headers = lines[0].split(',').map(h=>h.trim());
            const data = lines.slice(1).map(l => {
                let curr='', inQ=false, vals=[];
                for(let c of l){ if(c==='"')inQ=!inQ; else if(c===','&&!inQ){vals.push(curr);curr='';} else curr+=c; }
                vals.push(curr);
                return headers.reduce((a,h,i)=>({...a, [h]:vals[i]?.trim()||''}), {});
            });
            rawData = data;

            // FIX: Sort Data by Date FIRST to ensure alignment
            data.sort((a, b) => {
                const da = a.Date.split('/').reverse().join('');
                const db = b.Date.split('/').reverse().join('');
                return da.localeCompare(db);
            });

            // Parsers
            const num = (v) => parseFloat((String(v)||'0').replace(/,/g,'').replace('%','')) || 0;
            const hr = (t) => { if(!t)return 0; const p=t.split(':').map(Number); return (p[0]||0)+(p[1]||0)/60 + (p[2]||0)/3600; };
            const fmt = (n) => n.toLocaleString();

            const curData = data.filter(d => d.Date.endsWith('/11/2025'));
            const prevData = data.filter(d => d.Date.endsWith('/10/2025'));
            
            // --- GENERATE FULL MONTH TIMELINE (Calendar Mapping) ---
            // Create list of 1-30 Nov 2025
            const fullMonthDates = [];
            for (let i = 1; i <= 30; i++) {
                fullMonthDates.push(`${String(i).padStart(2, '0')}/11`);
            }

            // Map Actual Data to Calendar
            // Find data for each day. If missing, put null/0.
            const chartDataOEE = [];
            const chartDataP = [];
            const chartDataA = [];
            const chartDataSpeed = [];
            const chartBubbles = [];

            fullMonthDates.forEach(dateStr => {
                // Find row in curData that matches "DD/MM/2025"
                const fullDate = `${dateStr}/2025`;
                const d = curData.find(row => row.Date === fullDate);

                if (d) {
                    chartDataOEE.push(num(d.OEE));
                    chartDataP.push(num(d.P));
                    chartDataA.push(num(d.A));
                    chartDataSpeed.push(num(d['Product/H']));
                    
                    // Bubble Logic: Only add object if loss exists, otherwise null
                    // CRITICAL FIX: Add object with y:null when no loss to keep alignment with index and avoid "reading x of null"
                    if (d['BD Time'] && d['BD Time'].trim()) {
                        chartBubbles.push({ 
                            x: dateStr, 
                            y: num(d['Product/H']), 
                            r: Math.min(Math.max(hr(d['BD Time'])*6, 4), 25), 
                            note: d.Note, 
                            dur: hr(d['BD Time']) 
                        });
                    } else {
                        chartBubbles.push({ x: dateStr, y: null, r: 0 }); // Safe empty bubble
                    }
                } else {
                    // Missing Day -> Null/Gap for ALL
                    chartDataOEE.push(null);
                    chartDataP.push(null);
                    chartDataA.push(null);
                    chartDataSpeed.push(null);
                    chartBubbles.push({ x: dateStr, y: null, r: 0 }); // Safe empty bubble
                }
            });

            // Re-define base vars for KPIs (still use actual data)
            const curOEE = curData.filter(d => d.OEE);
            const prevOEE = prevData.filter(d => d.OEE);

            // --- 1. OVERVIEW KPIs ---
            const avg = (d,k) => d.length ? d.reduce((s,x)=>s+num(x[k]),0)/d.length : 0;
            const kpis = { oee: avg(curOEE,'OEE'), a: avg(curOEE,'A'), p: avg(curOEE,'P'), q: avg(curOEE,'Q') };
            const pkpis = { oee: avg(prevOEE,'OEE'), a: avg(prevOEE,'A'), p: avg(prevOEE,'P'), q: avg(prevOEE,'Q') };
            
            const getSpeed = (d) => { const v=d.filter(x=>num(x['Product/H'])>0); return v.length?v.reduce((s,x)=>s+num(x['Product/H']),0)/v.length:0; };
            const curSpd = getSpeed(curData);
            const prevSpd = getSpeed(prevData);

            const renderTrend = (c,p,u='', reverse=false) => {
                const d = c-p;
                const isUp = reverse ? d<0 : d>=0;
                const cls = isUp ? 'trend-up' : 'trend-down';
                const ico = d>=0 ? 'up' : 'down';
                return `<span class="trend-badge ${cls}"><i class="fa-solid fa-caret-${ico}"></i> ${Math.abs(d).toFixed(1)}${u}</span> <span class="text-[var(--text-sub)] text-xs hidden lg:inline">vs last month</span>`;
            };

            animateValue(document.getElementById('kpi-oee'), 0, kpis.oee, 1000, (v)=>v.toFixed(1)+'%');
            setHtml('kpi-oee-comp', renderTrend(kpis.oee, pkpis.oee, '%'));
            document.getElementById('oee-bar').style.width = kpis.oee + '%';

            animateValue(document.getElementById('kpi-a'), 0, kpis.a, 1000, (v)=>v.toFixed(1)+'%');
            setHtml('kpi-a-comp', renderTrend(kpis.a, pkpis.a, '%'));

            animateValue(document.getElementById('kpi-p'), 0, kpis.p, 1000, (v)=>v.toFixed(1)+'%');
            setHtml('kpi-p-comp', renderTrend(kpis.p, pkpis.p, '%'));

            animateValue(document.getElementById('kpi-q'), 0, kpis.q, 1000, (v)=>v.toFixed(1)+'%');
            setHtml('kpi-q-comp', renderTrend(kpis.q, pkpis.q, '%'));

            animateValue(document.getElementById('kpi-prod'), 0, curSpd, 1200, (v)=>Math.round(v).toLocaleString());
            setHtml('kpi-prod-comp', renderTrend(curSpd, prevSpd));


            // --- 2. SUMMARY ---
            const sum = (d,k) => d.reduce((s,x)=>s+num(x[k]),0);
            const tot = sum(curData, 'Total Product');
            const def = sum(curData, 'Sum Defect');
            const pTot = sum(prevData, 'Total Product');
            const pDef = sum(prevData, 'Sum Defect');
            const rate = tot ? (def/tot)*100 : 0;

            animateValue(document.getElementById('kpi-total-eggs'), 0, tot, 1500, (v)=>Math.round(v).toLocaleString());
            setHtml('kpi-total-eggs-comp', renderTrend(tot, pTot));

            animateValue(document.getElementById('kpi-total-defect'), 0, def, 1500, (v)=>Math.round(v).toLocaleString());
            setHtml('kpi-total-defect-comp', renderTrend(def, pDef, '', true));

            setText('kpi-defect-rate', rate.toFixed(2)+'%');
            document.getElementById('defect-bar').style.width = Math.min(rate*10, 100) + '%';


            // --- 3. LOSS ---
            const lossEvents = curData.filter(d=>d['BD Time']&&d['BD Time'].trim());
            const totalLossHrs = lossEvents.reduce((s,d)=>s+hr(d['BD Time']), 0);
            
            animateValue(document.getElementById('kpi-total-loss'), 0, totalLossHrs, 1000, (v)=>v.toFixed(2));
            animateValue(document.getElementById('kpi-total-events'), 0, lossEvents.length, 1000, (v)=>v);

            // FIX: Sort Loss Table by DATE Chronologically
            const sortedLoss = [...lossEvents].sort((a,b) => {
                 const da = a.Date.split('/').reverse().join('');
                 const db = b.Date.split('/').reverse().join('');
                 return da.localeCompare(db);
            });
            
            setHtml('table-loss-top', sortedLoss.map(l => `
                <tr class="align-top border-b border-[var(--card-border)] last:border-0">
                    <td class="font-mono text-xs text-[var(--text-sub)] py-2">${l.Date.substring(0,5)}</td>
                    <td class="text-sm py-2">${l.Note}</td>
                    <td class="text-right font-mono text-red-400 font-bold py-2">${l['BD Time']}</td>
                </tr>
            `).join(''));

            // --- 4. DETAILS SUPPLEMENTARY METRICS (UPDATED) ---
            const validWorkDays = curData.filter(d => d['Start Time'] && d['Finish Time'] && d['Start Time'] !== '-' && d['Finish Time'] !== '-');
            
            // A) Avg Finish Time
            const totalFinishMins = validWorkDays.reduce((s, d) => s + timeToMins(d['Finish Time']), 0);
            const avgFinishMins = validWorkDays.length ? totalFinishMins / validWorkDays.length : 0;
            setHtml('det-avg-finish', minsToTime(avgFinishMins) + ' น.');

            // B) Avg Operation Time (Corrected: Use 'Oparation Time' column)
            // Filter days that have "Oparation Time" data
            const validOpDays = curData.filter(d => d['Oparation Time'] && d['Oparation Time'] !== '-' && timeToSecs(d['Oparation Time']) > 0);
            const totalOpSecs = validOpDays.reduce((s, d) => s + timeToSecs(d['Oparation Time']), 0);
            const avgOpSecs = validOpDays.length ? totalOpSecs / validOpDays.length : 0;
            setHtml('det-avg-op', secsToTime(avgOpSecs)); 
            setHtml('det-avg-op-count', `(เฉลี่ย ${validOpDays.length} วัน)`);

            // C) Max Finish Time
            let maxFinishMins = -1;
            let maxFinishStr = '-';
            let maxFinishDate = '-';
            validWorkDays.forEach(d => {
                const fm = timeToMins(d['Finish Time']);
                if(fm > maxFinishMins) {
                    maxFinishMins = fm;
                    maxFinishStr = d['Finish Time'];
                    maxFinishDate = d.Date.substring(0,5);
                }
            });
            setHtml('det-max-finish', maxFinishStr);
            setHtml('det-max-finish-date', `วันที่ ${maxFinishDate}`);

            // D) Avg Eggs & Defect per Day (Corrected: Use specific columns)
            // Avg Eggs: 'Total producct_Machine'
            const validEggDays = curData.filter(d => num(d['Total producct_Machine']) > 0);
            const totalEggs = validEggDays.reduce((s, d) => s + num(d['Total producct_Machine']), 0);
            const avgEggs = validEggDays.length ? totalEggs / validEggDays.length : 0;
            
            // Avg Defect: 'Sum Defect'
            const validDefDays = curData.filter(d => num(d['Sum Defect']) > 0);
            const totalDefs = validDefDays.reduce((s, d) => s + num(d['Sum Defect']), 0);
            const avgDef = validDefDays.length ? totalDefs / validDefDays.length : 0;

            animateValue(document.getElementById('det-avg-egg'), 0, avgEggs, 1000, (v)=>parseInt(v).toLocaleString());
            animateValue(document.getElementById('det-avg-def'), 0, avgDef, 1000, (v)=>parseInt(v).toLocaleString());


            // --- 5. DATA TABLE ---
            // FIX: Ensure table is also sorted by date chronologically
            const sortedData = [...curData].sort((a,b) => {
                 const da = a.Date.split('/').reverse().join('');
                 const db = b.Date.split('/').reverse().join('');
                 return da.localeCompare(db);
            });

            setHtml('table-full', sortedData.map(d => {
                const oee = num(d.OEE);
                const status = oee >= 80 ? 'status-success' : oee >= 60 ? 'status-warning' : 'status-danger';
                return `
                <tr class="interactive-row hover:bg-white/5 transition-colors">
                    <td class="font-mono text-[var(--text-sub)]">${d.Date.substring(0,5)}</td>
                    <td class="text-center font-mono text-xs text-blue-400 opacity-75">${d['Start Time']||'-'} - ${d['Finish Time']||'-'}</td>
                    <td class="text-center"><span class="status-pill ${status}">${d.OEE||'-'}</span></td>
                    <td class="text-right font-mono text-[var(--text-main)]">${Math.round(num(d['Product/H'])).toLocaleString()}</td>
                    <td class="text-right font-bold text-[var(--text-main)]">${Math.round(num(d['Total Product'])).toLocaleString()}</td>
                    <td class="text-right text-red-400 font-mono">${Math.round(num(d['Sum Defect'])).toLocaleString()}</td>
                    <td class="text-center font-mono ${d['BD Time']?'text-orange-400':'text-[var(--text-sub)]'} opacity-90">${d['BD Time']||'-'}</td>
                    <td class="text-xs text-[var(--text-sub)] truncate max-w-[120px]" title="${d.Note}">${d.Note||''}</td>
                </tr>
            `}).join(''));

            // --- 6. CHARTS ---
            const theme = localStorage.getItem('theme')||'dark';
            const gridCol = theme==='dark'?'#334155':'#e2e8f0';
            const txtCol = theme==='dark'?'#94a3b8':'#64748b';
            Chart.defaults.color = txtCol;
            Chart.defaults.borderColor = gridCol;
            
            // Chart OEE (Uses Full Month Mapped Data)
            if(document.getElementById('chartOEE')) {
                if(charts.oee) charts.oee.destroy();
                charts.oee = new Chart(document.getElementById('chartOEE'), {
                    type: 'line',
                    data: {
                        labels: fullMonthDates, // Use 1-30 Nov
                        datasets: [
                            { label: 'OEE', data: chartDataOEE, borderColor: '#a855f7', backgroundColor: 'rgba(168, 85, 247, 0.1)', fill: true, tension: 0.4, pointRadius: 3 },
                            { label: 'P', data: chartDataP, borderColor: '#f59e0b', borderDash:[4,4], borderWidth: 1.5, pointRadius: 0 },
                            { label: 'A', data: chartDataA, borderColor: '#06b6d4', borderDash:[4,4], borderWidth: 1.5, pointRadius: 0 }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        interaction: { mode: 'index', intersect: false },
                        plugins: { 
                            legend: { labels: { usePointStyle: true, boxWidth: 8 } },
                            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.raw ? ctx.raw.toFixed(1)+'%' : 'No Data'}` } }
                        },
                        scales: { x: { grid: { display: false } }, y: { beginAtZero: true, max: 100, grid: { color: gridCol } } }
                    }
                });
            }

            // Chart Speed vs Loss (Uses Full Month Mapped Data)
            if(document.getElementById('chartSpeedLoss')) {
                if(charts.speed) charts.speed.destroy();
                charts.speed = new Chart(document.getElementById('chartSpeedLoss'), {
                    type: 'line',
                    data: {
                        labels: fullMonthDates, // Use 1-30 Nov
                        datasets: [
                            { type: 'bubble', label: 'Loss Event', data: chartBubbles, backgroundColor: 'rgba(239,68,68,0.7)', borderColor: '#ef4444' },
                            { type: 'line', label: 'Speed', data: chartDataSpeed, borderColor: '#a855f7', tension: 0.3, borderWidth: 2, pointRadius: 0 }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: { x: { grid: { display: false } } },
                        plugins: { 
                            tooltip: { 
                                callbacks: { 
                                    label: c => {
                                        if(c.dataset.type === 'bubble') {
                                            // Handle "empty bubble" gracefully
                                            if (c.raw.y === null) return null;
                                            return `Loss: ${c.raw.note} (${decimalHoursToHM(c.raw.dur)})`;
                                        }
                                        if(c.raw === null) return null;
                                        return `Speed: ${Math.round(c.raw).toLocaleString()} Eggs/Hr`;
                                    }
                                } 
                            } 
                        }
                    }
                });
            }

            // Chart Coop
            const getCoop = (ds) => [1,2,3,4,5,6].map(i => {
                const v = ds.filter(d=>hr(d[`H${i}_Oparation`])>0);
                return v.length ? v.reduce((s,x)=>s+hr(x[`H${i}_Oparation`]),0)/v.length : 0;
            });
            
            if(document.getElementById('chartCoop')) {
                if(charts.coop) charts.coop.destroy();
                charts.coop = new Chart(document.getElementById('chartCoop'), {
                    type: 'bar',
                    data: {
                        labels: ['H1','H2','H3','H4','H5','H6'],
                        datasets: [
                            { label: 'Nov', data: getCoop(curData), backgroundColor: '#38bdf8', borderRadius: 4 },
                            { label: 'Oct', data: getCoop(prevData), backgroundColor: '#64748b', borderRadius: 4 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } } } }
                });
            }

            const tNov = curData.reduce((s,d)=>s+hr(d['Up Time']),0)/curData.length;
            const tOct = prevData.reduce((s,d)=>s+hr(d['Up Time']),0)/prevData.length;
            const saved = tOct ? ((tOct-tNov)/tOct)*100 : 0;
            setHtml('badge-eff', `<i class="fa-solid fa-bolt text-yellow-400"></i> Efficiency (Up Time): เร็วขึ้น ${saved.toFixed(1)}%`);
        }

        init();
    </script>
</body>
</html>
