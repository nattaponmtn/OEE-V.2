<!DOCTYPE html>
<html lang="th" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OEE Monitor | พฤศจิกายน 2568</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Light Mode (Default) Values */
            --bg-main: #f1f5f9;
            --card-bg: #ffffff;
            --card-border: #e2e8f0;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --chart-grid: #e2e8f0;
            --chart-text: #64748b;
            --glass-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --sub-card-bg: #f8fafc;
            
            /* Status Colors (Keep mostly same but tweak for contrast if needed) */
            --accent-green: #22c55e;
            --accent-red: #ef4444;
        }

        [data-theme="dark"] {
            /* Dark Mode Values */
            --bg-main: #0f172a;
            --card-bg: #1e293b;
            --card-border: #334155;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --chart-grid: #334155;
            --chart-text: #94a3b8;
            --glass-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --sub-card-bg: rgba(30, 41, 59, 0.5);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dashboard-container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Card Styles */
        .glass-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--glass-shadow);
            transition: transform 0.2s, background-color 0.3s, border-color 0.3s;
        }
        .glass-card:hover {
            border-color: #64748b; /* Neutral hover */
        }
        [data-theme="dark"] .glass-card:hover {
            border-color: #475569;
        }

        .sub-card {
            background-color: var(--sub-card-bg);
            border: 1px solid var(--card-border);
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* Typography & Layout */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin: 10px 0;
            /* Gradient Text Logic */
            background: -webkit-linear-gradient(45deg, #334155, #64748b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        [data-theme="dark"] .kpi-value {
            background: -webkit-linear-gradient(45deg, #fff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .kpi-label {
            color: var(--text-sub);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Trend Badges */
        .trend-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .trend-up { background: rgba(74, 222, 128, 0.15); color: #16a34a; }
        [data-theme="dark"] .trend-up { color: #4ade80; }
        
        .trend-down { background: rgba(248, 113, 113, 0.15); color: #dc2626; }
        [data-theme="dark"] .trend-down { color: #f87171; }

        /* Helpers */
        .text-theme-sub { color: var(--text-sub); }
        .text-theme-main { color: var(--text-main); }
        
        /* Grid Layouts */
        .grid-main {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .col-span-2 { grid-column: span 2; }
        .col-span-3 { grid-column: span 3; }
        .col-span-4 { grid-column: span 4; }
        .col-span-6 { grid-column: span 6; }
        .col-span-8 { grid-column: span 8; }
        .col-span-12 { grid-column: span 12; }

        @media (max-width: 1024px) {
            .col-span-2, .col-span-3, .col-span-4, .col-span-6, .col-span-8 { grid-column: span 12; }
        }

        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: var(--text-sub); font-weight: 600; border-bottom: 1px solid var(--card-border); }
        td { padding: 12px; border-bottom: 1px solid var(--card-border); color: var(--text-main); }
        tr:last-child td { border-bottom: none; }
        tr.hover-row:hover { background-color: rgba(100, 116, 139, 0.1); }

        /* Toggle Button */
        .theme-toggle {
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 9999px;
            border: 1px solid var(--card-border);
            background: var(--card-bg);
            color: var(--text-main);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        .theme-toggle:hover {
            background-color: var(--sub-card-bg);
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-purple-500">
                    <i class="fa-solid fa-chart-line mr-2"></i> OEE Monitor
                </h1>
                <p class="text-theme-sub mt-1" id="dashboard-date">พฤศจิกายน 2568</p>
            </div>
            <div class="flex gap-3 items-center">
                <button id="themeToggleBtn" class="theme-toggle">
                    <i class="fa-solid fa-moon"></i> <span>Dark</span>
                </button>
                
                <span class="px-4 py-2 rounded-lg sub-card text-sm text-theme-sub">
                    <i class="fa-solid fa-server mr-2 text-green-500"></i>Online
                </span>
            </div>
        </div>

        <div class="grid-main">
            <div class="glass-card col-span-4 flex flex-col justify-between relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                    <i class="fa-solid fa-gauge-high text-8xl text-theme-main"></i>
                </div>
                <div>
                    <div class="kpi-label">OEE (Overall Equipment Effectiveness)</div>
                    <div class="kpi-value" id="kpi-oee">0%</div>
                    <div id="kpi-oee-comp"></div>
                </div>
                <div class="w-full bg-slate-200 dark:bg-slate-700 h-2 rounded-full mt-4 overflow-hidden">
                    <div id="oee-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500" style="width: 0%"></div>
                </div>
            </div>

            <div class="glass-card col-span-2">
                <div class="flex justify-between mb-2">
                    <div class="kpi-label text-cyan-500"><i class="fa-solid fa-clock mr-1"></i> Availability</div>
                </div>
                <div class="kpi-value text-2xl" id="kpi-a">0%</div>
                <div id="kpi-a-comp" class="text-sm"></div>
            </div>

            <div class="glass-card col-span-2">
                <div class="flex justify-between mb-2">
                    <div class="kpi-label text-amber-500"><i class="fa-solid fa-bolt mr-1"></i> Performance</div>
                </div>
                <div class="kpi-value text-2xl" id="kpi-p">0%</div>
                <div id="kpi-p-comp" class="text-sm"></div>
            </div>

            <div class="glass-card col-span-2">
                <div class="flex justify-between mb-2">
                    <div class="kpi-label text-green-500"><i class="fa-solid fa-check-circle mr-1"></i> Quality</div>
                </div>
                <div class="kpi-value text-2xl" id="kpi-q">0%</div>
                <div id="kpi-q-comp" class="text-sm"></div>
            </div>

             <div class="glass-card col-span-2">
                <div class="flex justify-between mb-2">
                    <div class="kpi-label text-purple-500"><i class="fa-solid fa-box mr-1"></i> Prod/Hr</div>
                </div>
                <div class="kpi-value text-2xl" id="kpi-prod">0</div>
                <div id="kpi-prod-comp" class="text-sm"></div>
            </div>
        </div>

        <div class="grid-main">
            <div class="glass-card col-span-8">
                <h3 class="text-lg font-semibold mb-4 text-theme-main"><i class="fa-solid fa-chart-area mr-2 text-blue-500"></i>แนวโน้มประสิทธิภาพรายวัน</h3>
                <div class="chart-container">
                    <canvas id="oeeComponentsChart"></canvas>
                </div>
            </div>

            <div class="glass-card col-span-4 flex flex-col gap-4">
                <h3 class="text-lg font-semibold text-theme-main mb-2">สรุปยอดการผลิต</h3>
                
                <div class="sub-card p-4 rounded-lg flex justify-between items-center">
                    <div>
                        <div class="text-theme-sub text-xs uppercase">Total Eggs</div>
                        <div class="text-xl font-bold text-theme-main" id="kpi-total-eggs">0</div>
                    </div>
                    <div id="kpi-total-eggs-comp" class="text-right"></div>
                </div>

                <div class="sub-card p-4 rounded-lg flex justify-between items-center">
                    <div>
                        <div class="text-theme-sub text-xs uppercase">Total Defects</div>
                        <div class="text-xl font-bold text-red-500" id="kpi-total-defect">0</div>
                    </div>
                    <div id="kpi-total-defect-comp" class="text-right"></div>
                </div>

                <div class="sub-card p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-1">
                        <div class="text-theme-sub text-xs uppercase">Defect Rate</div>
                        <div class="text-xl font-bold text-theme-main" id="kpi-defect-rate">0%</div>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 h-1.5 rounded-full">
                        <div id="defect-bar" class="h-full bg-red-500 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid-main">
            <div class="glass-card col-span-4">
                <h3 class="text-lg font-semibold mb-4 text-theme-main"><i class="fa-solid fa-triangle-exclamation mr-2 text-orange-500"></i>Loss Analysis</h3>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="text-center p-3 sub-card rounded-lg">
                        <div class="text-orange-500 text-2xl font-bold" id="kpi-total-loss">0</div>
                        <div class="text-xs text-theme-sub">เวลารวมที่หยุด (ชม.)</div>
                    </div>
                    <div class="text-center p-3 sub-card rounded-lg">
                        <div class="text-purple-500 text-2xl font-bold" id="kpi-total-events">0</div>
                        <div class="text-xs text-theme-sub">จำนวนครั้ง</div>
                    </div>
                </div>
                <div class="overflow-y-auto max-h-[200px] pr-2">
                    <table class="text-sm w-full">
                        <tbody id="top-loss-table">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="glass-card col-span-8">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold text-theme-main"><i class="fa-solid fa-stopwatch mr-2 text-green-500"></i>เวลาเฉลี่ยรายโรงเรือน</h3>
                    <div id="efficiency-badge" class="px-3 py-1 sub-card rounded text-xs text-theme-sub">
                        </div>
                </div>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="coopTimeChart"></canvas>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- DATA & DASHBOARD LOGIC ---
        // FIX: Declare variables at the TOP scope to prevent ReferenceError in setTheme
        let oeeComponentsChartInstance, coopTimeChartInstance;

        // --- THEME MANAGEMENT ---
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const htmlElement = document.documentElement;
        
        // 1. Initialize Theme (Check LocalStorage or Default)
        const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark for continuity
        setTheme(savedTheme);

        // 2. Toggle Logic
        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = htmlElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        function setTheme(theme) {
            htmlElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Update Button UI
            if(theme === 'dark') {
                themeToggleBtn.innerHTML = '<i class="fa-solid fa-moon"></i> <span>Dark</span>';
            } else {
                themeToggleBtn.innerHTML = '<i class="fa-solid fa-sun text-yellow-500"></i> <span>Light</span>';
            }

            // Update Charts if they exist
            updateChartTheme(theme);
        }

        function updateChartTheme(theme) {
            const isDark = theme === 'dark';
            const gridColor = isDark ? '#334155' : '#e2e8f0';
            const textColor = isDark ? '#94a3b8' : '#64748b';

            Chart.defaults.borderColor = gridColor;
            Chart.defaults.color = textColor;

            // FIX: Add safety check for undefined instances
            if (typeof oeeComponentsChartInstance !== 'undefined' && oeeComponentsChartInstance) {
                oeeComponentsChartInstance.options.scales.y.grid.color = gridColor;
                oeeComponentsChartInstance.options.scales.x.grid.display = false;
                oeeComponentsChartInstance.update('none'); // Update without full animation
            }
            if (typeof coopTimeChartInstance !== 'undefined' && coopTimeChartInstance) {
                coopTimeChartInstance.options.scales.y.grid.color = gridColor;
                coopTimeChartInstance.update('none');
            }
        }


        async function fetchDataAndRender() {
            const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRlpC6mhBM2bPVYgz5pS6PAIW9Brzs6GAOH0wwFpfxB6eK_L5InKpqIcSusdOlRSLZ0swhFlqBiysx8/pub?gid=565758569&single=true&output=csv';
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network error');
                const csvText = await response.text();
                processData(csvText);
            } catch (error) {
                console.error("Error:", error);
                document.body.innerHTML = `<div class="p-10 text-center text-red-400">Failed to load data. Please check connection.</div>`;
            }
        }

        function processData(csvText) {
            // ... (CSV Parser same as before)
            function parseCsv(text) {
                const lines = text.trim().replace(/\r/g, "").split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                return lines.slice(1).map(line => {
                    const values = [];
                    let current = '', inQuotes = false;
                    for (let char of line) {
                        if (char === '"') inQuotes = !inQuotes;
                        else if (char === ',' && !inQuotes) { values.push(current); current = ''; }
                        else current += char;
                    }
                    values.push(current);
                    return headers.reduce((obj, header, i) => { obj[header] = values[i] ? values[i].trim() : ''; return obj; }, {});
                });
            }

            const allData = parseCsv(csvText);
            
            // Formatters
            const timeToHours = (t) => { if(!t) return 0; const p = t.split(':').map(Number); return (p[0]||0) + (p[1]||0)/60 + (p[2]||0)/3600; };
            const hoursToTimeString = (d) => { if(isNaN(d)||d<0) return "00:00:00"; const s = Math.round(d*3600); return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; };
            const parsePercent = (s) => parseFloat((s||'0').replace('%','')) || 0;
            const parseNumber = (s) => parseInt((String(s)||'0').replace(/,/g,''), 10) || 0;

            // --- DATE LOGIC (Nov vs Oct) ---
            const targetMonthIndex = 10; // November
            const targetYear = 2025;
            const currentMonthStr = `/${String(targetMonthIndex+1).padStart(2,'0')}/${targetYear}`;
            const prevMonthStr = `/${String(targetMonthIndex).padStart(2,'0')}/${targetYear}`;
            
            const latestData = allData.filter(d => d.Date && d.Date.endsWith(currentMonthStr));
            const prevData = allData.filter(d => d.Date && d.Date.endsWith(prevMonthStr));
            
            const latestOEE = latestData.filter(d => d.OEE);
            const prevOEE = prevData.filter(d => d.OEE);

            // --- KPI DISPLAY ---
            const calcAvg = (d) => {
                if(!d.length) return {A:0,P:0,Q:0,OEE:0,ProdH:0};
                const sum = d.reduce((a,b) => ({
                    A: a.A+parsePercent(b.A), P: a.P+parsePercent(b.P), Q: a.Q+parsePercent(b.Q), 
                    OEE: a.OEE+parsePercent(b.OEE), ProdH: a.ProdH+parseNumber(b['Product/H'])
                }), {A:0,P:0,Q:0,OEE:0,ProdH:0});
                return {A: sum.A/d.length, P: sum.P/d.length, Q: sum.Q/d.length, OEE: sum.OEE/d.length, ProdH: sum.ProdH/d.length};
            };

            const curAvg = calcAvg(latestOEE);
            const prvAvg = calcAvg(prevOEE);

            const renderTrend = (curr, prev, unit='', reverse=false) => {
                const diff = curr - prev;
                const isUp = reverse ? diff < 0 : diff >= 0;
                const colorClass = isUp ? 'trend-up' : 'trend-down';
                const icon = diff >= 0 ? '<i class="fa-solid fa-caret-up"></i>' : '<i class="fa-solid fa-caret-down"></i>';
                return `<span class="trend-badge ${colorClass}">${icon} ${Math.abs(diff).toFixed(2)}${unit}</span> <span class="text-theme-sub text-xs">vs last month</span>`;
            };

            document.getElementById('kpi-oee').textContent = curAvg.OEE.toFixed(2) + '%';
            document.getElementById('kpi-oee-comp').innerHTML = renderTrend(curAvg.OEE, prvAvg.OEE, '%');
            document.getElementById('oee-bar').style.width = `${curAvg.OEE}%`;

            document.getElementById('kpi-a').textContent = curAvg.A.toFixed(2) + '%';
            document.getElementById('kpi-a-comp').innerHTML = renderTrend(curAvg.A, prvAvg.A, '%');

            document.getElementById('kpi-p').textContent = curAvg.P.toFixed(2) + '%';
            document.getElementById('kpi-p-comp').innerHTML = renderTrend(curAvg.P, prvAvg.P, '%');

            document.getElementById('kpi-q').textContent = curAvg.Q.toFixed(2) + '%';
            document.getElementById('kpi-q-comp').innerHTML = renderTrend(curAvg.Q, prvAvg.Q, '%');

            document.getElementById('kpi-prod').textContent = Math.round(curAvg.ProdH).toLocaleString();
            document.getElementById('kpi-prod-comp').innerHTML = renderTrend(curAvg.ProdH, prvAvg.ProdH);

            // Production Stats
            const sumProd = (d) => d.reduce((s,x) => s+parseNumber(x['Total Product']), 0);
            const sumDefect = (d) => d.reduce((s,x) => s+parseNumber(x['Sum Defect']), 0);
            
            const curProd = sumProd(latestData);
            const curDefect = sumDefect(latestData);
            const prevProd = sumProd(prevData);
            const prevDefect = sumDefect(prevData);
            const defectRate = curProd > 0 ? (curDefect/curProd)*100 : 0;

            document.getElementById('kpi-total-eggs').textContent = curProd.toLocaleString();
            document.getElementById('kpi-total-eggs-comp').innerHTML = renderTrend(curProd, prevProd);
            
            document.getElementById('kpi-total-defect').textContent = curDefect.toLocaleString();
            document.getElementById('kpi-total-defect-comp').innerHTML = renderTrend(curDefect, prevDefect, '', true);

            document.getElementById('kpi-defect-rate').textContent = defectRate.toFixed(2) + '%';
            document.getElementById('defect-bar').style.width = `${Math.min(defectRate * 100, 100)}%`;

            // --- LOSS ANALYSIS ---
            const lossData = latestData.filter(d => d['BD Time'] && d['BD Time'].trim() !== '');
            const totalLossHrs = lossData.reduce((s,d) => s + timeToHours(d['BD Time']), 0);
            
            document.getElementById('kpi-total-loss').textContent = totalLossHrs.toFixed(2);
            document.getElementById('kpi-total-events').textContent = lossData.length;
            
            const topLosses = lossData.sort((a,b) => timeToHours(b['BD Time']) - timeToHours(a['BD Time'])).slice(0, 5);
            document.getElementById('top-loss-table').innerHTML = topLosses.map(d => `
                <tr class="hover-row transition-colors">
                    <td class="text-theme-sub font-mono text-xs">${d.Date.substring(0,5)}</td>
                    <td><span class="text-theme-main text-sm">${d.Note}</span></td>
                    <td class="text-right text-red-500 font-bold">${d['BD Time']}</td>
                </tr>
            `).join('');

            // --- EFFICIENCY & CHARTS ---
            // Prepare initial colors based on current theme
            const isDark = htmlElement.getAttribute('data-theme') === 'dark';
            const gridColor = isDark ? '#334155' : '#e2e8f0';
            const textColor = isDark ? '#94a3b8' : '#64748b';
            Chart.defaults.borderColor = gridColor;
            Chart.defaults.color = textColor;

            // OEE Chart
            if(oeeComponentsChartInstance) oeeComponentsChartInstance.destroy();
            oeeComponentsChartInstance = new Chart(document.getElementById('oeeComponentsChart'), {
                type: 'line',
                data: {
                    labels: latestOEE.map(d => d.Date.substring(0,5)),
                    datasets: [
                        { label: 'OEE', data: latestOEE.map(d => parsePercent(d.OEE)), borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 4 },
                        { label: 'Performance', data: latestOEE.map(d => parsePercent(d.P)), borderColor: '#f59e0b', borderDash: [4,4], borderWidth: 1.5, pointRadius: 0 },
                        { label: 'Availability', data: latestOEE.map(d => parsePercent(d.A)), borderColor: '#38bdf8', borderDash: [4,4], borderWidth: 1.5, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { usePointStyle: true, boxWidth: 6 } } },
                    scales: { x: { grid: { display: false } }, y: { grid: { color: gridColor } } }
                }
            });

            // Coop Time Chart
            const calcAvgTime = (d) => {
                const avgs = [];
                for(let i=1; i<=6; i++) {
                    const days = d.filter(x => timeToHours(x[`H${i}_Oparation`]) > 0);
                    const sum = days.reduce((s,x) => s + timeToHours(x[`H${i}_Oparation`]), 0);
                    avgs.push(days.length > 0 ? sum/days.length : 0);
                }
                return avgs;
            };
            const curCoopTimes = calcAvgTime(latestData);
            const prevCoopTimes = calcAvgTime(prevData);

            if(coopTimeChartInstance) coopTimeChartInstance.destroy();
            coopTimeChartInstance = new Chart(document.getElementById('coopTimeChart'), {
                type: 'bar',
                data: {
                    labels: ['H1', 'H2', 'H3', 'H4', 'H5', 'H6'],
                    datasets: [
                        { label: 'พ.ย.', data: curCoopTimes, backgroundColor: '#38bdf8', borderRadius: 4 },
                        { label: 'ต.ค.', data: prevCoopTimes, backgroundColor: '#64748b', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { grid: { color: gridColor }, ticks: { callback: v => hoursToTimeString(v).substring(0,5) } }, x: { grid: { display: false } } }
                }
            });

            // Insight Badge
            const calcUpTimeAvg = (d) => {
                const valid = d.filter(x => timeToHours(x['Up Time']) > 0);
                if(!valid.length) return 0;
                return valid.reduce((s,x) => s+timeToHours(x['Up Time']), 0) / valid.length;
            };
            const curUpAvg = calcUpTimeAvg(latestData);
            const prevUpAvg = calcUpTimeAvg(prevData);
            const improve = prevUpAvg > 0 ? ((prevUpAvg - curUpAvg)/prevUpAvg)*100 : 0;
            
            document.getElementById('efficiency-badge').innerHTML = `
                <span class="${improve >= 0 ? 'text-green-500' : 'text-red-500'}">
                    <i class="fa-solid fa-arrow-trend-${improve >= 0 ? 'up' : 'down'}"></i> 
                    เร็วขึ้น ${improve.toFixed(2)}%
                </span>
            `;
        }

        document.addEventListener('DOMContentLoaded', fetchDataAndRender);
    </script>
</body>
</html>
