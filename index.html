<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OEE Deep Dive & Root Cause Analysis | สิงหาคม 2568</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">


    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 350px;
            max-height: 450px;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            border: 1px solid #e2e8f0; /* slate-200 */
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b; /* slate-800 */
            border-bottom: 3px solid #4f46e5; /* indigo-600 */
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .kpi-card {
            background-color: #ffffff;
            padding: 1.25rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        .kpi-card h3 {
            font-weight: 600;
            color: #475569; /* slate-600 */
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        .kpi-card .value {
            font-weight: 700;
            font-size: 2.25rem;
            line-height: 1.1;
        }
        .kpi-card .subtext {
            font-size: 0.875rem;
            color: #64748b; /* slate-500 */
            margin-top: 0.5rem;
            min-height: 20px;
        }
        .kpi-card .change-up { color: #16a34a; }
        .kpi-card .change-down { color: #dc2626; }
        .chartjs-tooltip {
            font-family: 'Sarabun', sans-serif !important;
        }
        .chartjs-tooltip-footer {
            padding-top: 8px !important;
            margin-top: 8px !important;
            border-top: 1px solid #ccc !important;
            font-style: italic !important;
            color: #eee !important;
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <div class="container mx-auto p-4 md:p-6 max-w-7xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">OEE Deep Dive & Root Cause Analysis</h1>
            <p id="dashboard-subtitle" class="text-slate-600 mt-2 text-lg">สรุปผลการดำเนินงานเครื่องคัดไข่</p>
        </header>

        <section class="mb-8">
            <h2 id="kpi-title" class="section-title">ภาพรวมผลการดำเนินงานหลัก</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="kpi-card">
                    <h3>Avg. OEE</h3>
                    <p id="kpi-oee" class="value text-indigo-600">0%</p>
                    <p id="kpi-oee-comp" class="subtext"></p>
                </div>
                <div class="kpi-card">
                    <h3>Avg. Availability</h3>
                    <p id="kpi-a" class="value text-cyan-600">0%</p>
                    <p id="kpi-a-comp" class="subtext"></p>
                </div>
                <div class="kpi-card">
                    <h3>Avg. Performance</h3>
                    <p id="kpi-p" class="value text-amber-600">0%</p>
                    <p id="kpi-p-comp" class="subtext"></p>
                </div>
                <div class="kpi-card">
                    <h3>Avg. Quality</h3>
                    <p id="kpi-q" class="value text-slate-600">0%</p>
                    <p id="kpi-q-comp" class="subtext"></p>
                </div>
                <div class="kpi-card">
                    <h3>Avg. Product/H</h3>
                    <p id="kpi-prod" class="value text-teal-600">0</p>
                    <p id="kpi-prod-comp" class="subtext"></p>
                </div>
            </div>
        </section>
        
        <section class="card mb-8">
            <h2 id="analysis-title" class="section-title">บทวิเคราะห์ OEE และผลผลิตรายวัน</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                 <div class="kpi-card">
                    <h3>จำนวนไข่ผ่านเครื่องคัด (ฟอง)</h3>
                    <p id="kpi-total-eggs" class="value text-blue-700">0</p>
                    <p id="kpi-total-eggs-comp" class="subtext"></p>
                </div>
                <div class="kpi-card">
                    <h3>ไข่เสียหายทั้งหมด (ฟอง)</h3>
                    <p id="kpi-total-defect" class="value text-red-700">0</p>
                    <p id="kpi-total-defect-comp" class="subtext"></p>
                </div>
                <div class="kpi-card">
                    <h3>อัตราไข่เสียหาย (Defect Rate)</h3>
                    <p id="kpi-defect-rate" class="value text-gray-700">0%</p>
                    <p class="subtext">&nbsp;</p> </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                <div>
                    <h3 class="text-lg font-semibold text-center text-slate-700 mb-2">แนวโน้ม OEE, A, P, Q รายวัน</h3>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="oeeComponentsChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-center text-slate-700 mb-2">แนวโน้มผลผลิตและไข่เสียหายรายวัน</h3>
                     <div class="chart-container" style="height: 350px;">
                        <canvas id="productionDefectChart"></canvas>
                    </div>
                </div>
            </div>
        </section>


        <section class="card mb-8">
            <h2 id="loss-time-title" class="section-title">เจาะลึกสาเหตุของเวลาที่สูญเสีย</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                 <div class="kpi-card">
                    <h3>เวลารวมที่หยุด (ชม.)</h3>
                    <p id="kpi-total-loss" class="value text-orange-600">0</p>
                </div>
                <div class="kpi-card">
                    <h3>จำนวนเหตุการณ์</h3>
                    <p id="kpi-total-events" class="value text-purple-600">0</p>
                </div>
                <div class="kpi-card">
                    <h3>เวลาเฉลี่ยที่หยุด/เหตุการณ์ (นาที)</h3>
                    <p id="kpi-avg-loss-event" class="value text-slate-600">0</p>
                </div>
            </div>
            
             <div class="mt-8">
                <h3 class="text-lg font-semibold text-center text-slate-700 mb-2">5 อันดับเหตุการณ์ที่ทำให้เกิด Loss Time สูงสุด</h3>
                <div class="overflow-x-auto max-w-3xl mx-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-2 text-left font-semibold text-slate-600">วันที่</th>
                                <th class="p-2 text-left font-semibold text-slate-600">สาเหตุ</th>
                                <th class="p-2 text-right font-semibold text-slate-600">เวลาที่สูญเสีย</th>
                            </tr>
                        </thead>
                        <tbody id="top-loss-table">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="card">
            <h2 class="section-title">วิเคราะห์ประสิทธิภาพการทำงาน (Efficiency Analysis)</h2>
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                <div>
                    <h3 class="text-lg font-semibold text-center text-slate-700 mb-2">เวลาเฉลี่ยที่ใช้คัดไข่ในแต่ละโรงเรือน (ชม.)</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="coopTimeChart"></canvas>
                    </div>
                </div>
                <div class="p-6 bg-slate-50 rounded-lg">
                    <h3 class="text-lg font-semibold text-slate-800">บทวิเคราะห์ประสิทธิภาพรายโรงเรือน</h3>
                    <div id="efficiency-insight" class="mt-2 text-slate-600 space-y-2">
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script>
        // --- CHART INSTANCES ---
        let oeeComponentsChartInstance, productionDefectChartInstance, coopTimeChartInstance;

        // --- DATA FETCHING AND PROCESSING ---
        async function fetchDataAndRender() {
            const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRlpC6mhBM2bPVYgz5pS6PAIW9Brzs6GAOH0wwFpfxB6eK_L5InKpqIcSusdOlRSLZ0swhFlqBiysx8/pub?gid=565758569&single=true&output=csv';
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                const csvText = await response.text();
                processData(csvText);
            } catch (error) {
                console.error("Failed to fetch or process data:", error);
                document.body.innerHTML = `<div class="p-8 text-center text-red-600"><h3>เกิดข้อผิดพลาดในการโหลดข้อมูล</h3><p>${error.message}</p></div>`;
            }
        }

        function processData(csvText) {
            // --- DATA PARSING ---
            function parseCsv(text) {
                const lines = text.trim().replace(/\r/g, "").split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const data = lines.slice(1).map(line => {
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    for (let char of line) {
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current);
                    
                    const entry = {};
                    headers.forEach((header, i) => {
                        entry[header] = values[i] ? values[i].trim() : '';
                    });
                    return entry;
                });
                return data;
            }

            const allData = parseCsv(csvText);

            // --- HELPER FUNCTIONS ---
            const timeToHours = (timeStr) => {
                if (!timeStr || typeof timeStr !== 'string' || timeStr.trim() === '') return 0;
                const parts = timeStr.split(':').map(Number);
                if (parts.length >= 2) {
                    const hours = parts[0] || 0;
                    const minutes = parts[1] || 0;
                    const seconds = parts[2] || 0;
                    return hours + minutes / 60 + seconds / 3600;
                }
                return 0;
            };
             const hoursToTimeString = (decimalHours) => {
                if (isNaN(decimalHours) || decimalHours < 0) return "00:00:00";
                const totalSeconds = Math.round(decimalHours * 3600);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                const pad = (num) => String(num).padStart(2, '0');
                return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            };
            const parsePercent = (pStr) => (!pStr || typeof pStr !== 'string') ? 0 : parseFloat(pStr.replace('%', '')) || 0;
            const parseNumber = (nStr) => (!nStr || typeof nStr !== 'string') ? 0 : parseInt(String(nStr).replace(/,/g, ''), 10) || 0;

            // --- DYNAMIC MONTH DETECTION ---
            const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const dates = allData.map(d => {
                const parts = d.Date.split('/');
                if (parts.length === 3) {
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
                return null;
            }).filter(d => d && !isNaN(d));

            const maxDate = new Date(Math.max.apply(null, dates));
            const currentMonth = maxDate.getMonth() + 1;
            const currentYear = maxDate.getFullYear();
            const currentMonthName = thaiMonths[maxDate.getMonth()];

            const prevMonthDate = new Date(maxDate);
            prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
            const previousMonth = prevMonthDate.getMonth() + 1;
            const previousYear = prevMonthDate.getFullYear();
            const previousMonthShortName = thaiMonths[prevMonthDate.getMonth()].substring(0, 3) + '.';

            const currentMonthString = `/${String(currentMonth).padStart(2, '0')}/${currentYear}`;
            const previousMonthString = `/${String(previousMonth).padStart(2, '0')}/${previousYear}`;

            const latestMonthData = allData.filter(d => d.Date && d.Date.endsWith(currentMonthString));
            const previousMonthData = allData.filter(d => d.Date && d.Date.endsWith(previousMonthString));
            
            const latestMonthDataWithOEE = latestMonthData.filter(d => d.OEE);
            const previousMonthDataWithOEE = previousMonthData.filter(d => d.OEE);

            // --- UPDATE TITLES ---
            document.title = `OEE Deep Dive | ${currentMonthName} ${currentYear + 543}`;
            document.getElementById('dashboard-subtitle').textContent = `สรุปผลการดำเนินงานเครื่องคัดไข่ | ${currentMonthName} ${currentYear + 543}`;
            document.getElementById('kpi-title').textContent = `ภาพรวมผลการดำเนินงานหลัก (${currentMonthName} ${currentYear + 543})`;
            document.getElementById('analysis-title').textContent = `บทวิเคราะห์ OEE และผลผลิตรายวัน (${currentMonthName} ${currentYear + 543})`;
            document.getElementById('loss-time-title').textContent = `เจาะลึกสาเหตุของเวลาที่สูญเสีย (${currentMonthName} ${currentYear + 543})`;


            // --- KPI CALCULATIONS ---
            const calculateAverages = (data) => {
                if (!data || data.length === 0) return { A: 0, P: 0, Q: 0, OEE: 0, ProdH: 0 };
                const totals = data.reduce((acc, day) => {
                    acc.A += parsePercent(day.A);
                    acc.P += parsePercent(day.P);
                    acc.Q += parsePercent(day.Q);
                    acc.OEE += parsePercent(day.OEE);
                    acc.ProdH += parseNumber(day['Product/H']);
                    return acc;
                }, { A: 0, P: 0, Q: 0, OEE: 0, ProdH: 0 });
                const count = data.length;
                return { A: (totals.A / count), P: (totals.P / count), Q: (totals.Q / count), OEE: (totals.OEE / count), ProdH: (totals.ProdH / count) };
            };
            const latestAvgs = calculateAverages(latestMonthDataWithOEE);
            const previousAvgs = calculateAverages(previousMonthDataWithOEE);
            const renderComparison = (current, previous, unit = '', higherIsBetter = true) => {
                const diff = current - previous;
                let changeClass = '';
                if (diff !== 0) {
                    if (higherIsBetter) {
                        changeClass = diff > 0 ? 'change-up' : 'change-down';
                    } else {
                        changeClass = diff < 0 ? 'change-up' : 'change-down';
                    }
                }
                const arrow = diff >= 0 ? '▲' : '▼';
                return `<span class="${changeClass}">${arrow} ${Math.abs(diff).toFixed(2)}${unit} vs ${previousMonthShortName}</span>`;
            };
            document.getElementById('kpi-oee').textContent = `${latestAvgs.OEE.toFixed(2)}%`;
            document.getElementById('kpi-oee-comp').innerHTML = renderComparison(latestAvgs.OEE, previousAvgs.OEE, '%');
            document.getElementById('kpi-a').textContent = `${latestAvgs.A.toFixed(2)}%`;
            document.getElementById('kpi-a-comp').innerHTML = renderComparison(latestAvgs.A, previousAvgs.A, '%');
            document.getElementById('kpi-p').textContent = `${latestAvgs.P.toFixed(2)}%`;
            document.getElementById('kpi-p-comp').innerHTML = renderComparison(latestAvgs.P, previousAvgs.P, '%');
            document.getElementById('kpi-q').textContent = `${latestAvgs.Q.toFixed(2)}%`;
            document.getElementById('kpi-q-comp').innerHTML = renderComparison(latestAvgs.Q, previousAvgs.Q, '%');
            document.getElementById('kpi-prod').textContent = `${Math.round(latestAvgs.ProdH).toLocaleString()}`;
            document.getElementById('kpi-prod-comp').innerHTML = renderComparison(latestAvgs.ProdH, previousAvgs.ProdH);

            // --- DETAILED OEE ANALYSIS ---
            const totalEggsLatest = latestMonthData.reduce((sum, day) => sum + parseNumber(day['Total Product']), 0);
            const totalDefectsLatest = latestMonthData.reduce((sum, day) => sum + parseNumber(day['Sum Defect']), 0);
            const totalEggsPrevious = previousMonthData.reduce((sum, day) => sum + parseNumber(day['Total Product']), 0);
            const totalDefectsPrevious = previousMonthData.reduce((sum, day) => sum + parseNumber(day['Sum Defect']), 0);
            const defectRateLatest = totalEggsLatest > 0 ? (totalDefectsLatest / totalEggsLatest) * 100 : 0;
            
            document.getElementById('kpi-total-eggs').textContent = totalEggsLatest.toLocaleString();
            document.getElementById('kpi-total-eggs-comp').innerHTML = renderComparison(totalEggsLatest, totalEggsPrevious, ' ฟอง');
            document.getElementById('kpi-total-defect').textContent = totalDefectsLatest.toLocaleString();
            document.getElementById('kpi-total-defect-comp').innerHTML = renderComparison(totalDefectsLatest, totalDefectsPrevious, ' ฟอง', false);
            document.getElementById('kpi-defect-rate').textContent = `${defectRateLatest.toFixed(2)}%`;
            
            // --- NEW CHARTS ---
            if (oeeComponentsChartInstance) oeeComponentsChartInstance.destroy();
            oeeComponentsChartInstance = new Chart(document.getElementById('oeeComponentsChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: latestMonthDataWithOEE.map(d => d.Date.substring(0, 5)),
                    datasets: [
                        { label: 'OEE (%)', data: latestMonthDataWithOEE.map(d => parsePercent(d.OEE)), borderColor: '#4f46e5', borderWidth: 3, tension: 0.1 },
                        { label: 'Availability (%)', data: latestMonthDataWithOEE.map(d => parsePercent(d.A)), borderColor: '#06b6d4', borderWidth: 1.5, borderDash: [5, 5], tension: 0.2 },
                        { label: 'Performance (%)', data: latestMonthDataWithOEE.map(d => parsePercent(d.P)), borderColor: '#f59e0b', borderWidth: 1.5, borderDash: [5, 5], tension: 0.2 },
                        { label: 'Quality (%)', data: latestMonthDataWithOEE.map(d => parsePercent(d.Q)), borderColor: '#64748b', borderWidth: 1.5, borderDash: [5, 5], tension: 0.2, yAxisID: 'yQuality' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { y: { beginAtZero: false, title: { display: true, text: 'OEE / A / P (%)' } }, yQuality: { position: 'right', beginAtZero: false, suggestedMin: 99.5, title: { display: true, text: 'Quality (%)' }, grid: { drawOnChartArea: false } } } }
            });

            if (productionDefectChartInstance) productionDefectChartInstance.destroy();
            productionDefectChartInstance = new Chart(document.getElementById('productionDefectChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: latestMonthData.map(d => d.Date.substring(0, 5)),
                    datasets: [
                        { label: 'ไข่เสียหาย (ฟอง)', type: 'line', data: latestMonthData.map(d => parseNumber(d['Sum Defect'])), borderColor: '#ef4444', borderWidth: 2, yAxisID: 'yDefects', tension: 0.1, pointRadius: 2 },
                        { label: 'ผลผลิตรวม (ฟอง)', data: latestMonthData.map(d => parseNumber(d['Total Product'])), backgroundColor: 'rgba(59, 130, 246, 0.7)', yAxisID: 'yProduction' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { yProduction: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'ผลผลิต (ฟอง)' } }, yDefects: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'ไข่เสียหาย (ฟอง)' }, grid: { drawOnChartArea: false } } } }
            });

            // --- LOSS TIME ANALYSIS ---
            const lossEventsLatest = latestMonthData.filter(d => d['BD Time'] && d['BD Time'].trim() !== '');
            const totalLossHoursLatest = lossEventsLatest.reduce((sum, day) => sum + timeToHours(day['BD Time']), 0);
            const totalEventsLatest = lossEventsLatest.length;
            const avgLossPerEventMinutes = totalEventsLatest > 0 ? (totalLossHoursLatest * 60) / totalEventsLatest : 0;
            document.getElementById('kpi-total-loss').textContent = `${totalLossHoursLatest.toFixed(2)}`;
            document.getElementById('kpi-total-events').textContent = totalEventsLatest;
            document.getElementById('kpi-avg-loss-event').textContent = `${avgLossPerEventMinutes.toFixed(1)}`;

            const topLosses = lossEventsLatest.sort((a, b) => timeToHours(b['BD Time']) - timeToHours(a['BD Time'])).slice(0, 5);
            document.getElementById('top-loss-table').innerHTML = topLosses.map(item => `<tr class="border-b border-slate-200 hover:bg-slate-50"><td class="p-2">${item.Date.substring(0,5)}</td><td class="p-2 text-slate-600">${item.Note}</td><td class="p-2 text-right font-semibold text-red-700">${item['BD Time']}</td></tr>`).join('');

            // --- EFFICIENCY ANALYSIS ---
            const calculateCoopAvgTimes = (data) => {
                const avgs = [];
                for (let i = 1; i <= 6; i++) {
                    if (i === 1) { // H1 is always 0 now
                        avgs.push(0);
                        continue;
                    }
                    const coopData = data.filter(day => timeToHours(day[`H${i}_Oparation`]) > 0);
                    const totalTime = coopData.reduce((sum, day) => sum + timeToHours(day[`H${i}_Oparation`]), 0);
                    avgs.push(coopData.length > 0 ? totalTime / coopData.length : 0);
                }
                return avgs;
            };
            const coopTimeData = { labels: ['H1', 'H2', 'H3', 'H4', 'H5', 'H6'], thisMonth: calculateCoopAvgTimes(latestMonthData), lastMonth: calculateCoopAvgTimes(previousMonthData) };
            
            if (coopTimeChartInstance) coopTimeChartInstance.destroy();
            coopTimeChartInstance = new Chart(document.getElementById('coopTimeChart').getContext('2d'), {
                type: 'bar',
                data: { labels: coopTimeData.labels, datasets: [ { label: currentMonthName, data: coopTimeData.thisMonth, backgroundColor: '#0d9488' }, { label: thaiMonths[previousMonth-1], data: coopTimeData.lastMonth, backgroundColor: '#a1a1aa' } ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { title: { display: true, text: 'เวลาเฉลี่ย (ชม.)' } } } }
            });

            // Efficiency analysis based on Avg. Up Time
            const calculateAvgUpTime = (data) => {
                const validDays = data.filter(day => timeToHours(day['Up Time']) > 0);
                if (validDays.length === 0) return 0;
                const totalUpTimeHours = validDays.reduce((sum, day) => sum + timeToHours(day['Up Time']), 0);
                return totalUpTimeHours / validDays.length;
            };

            const avgUpTimeLatest = calculateAvgUpTime(latestMonthData);
            const avgUpTimePrevious = calculateAvgUpTime(previousMonthData);
            
            const improvement = avgUpTimePrevious > 0 ? ((avgUpTimePrevious - avgUpTimeLatest) / avgUpTimePrevious * 100) : 0;
            
            document.getElementById('efficiency-insight').innerHTML = `<p>เวลาคัดไข่จริง (Up Time) เฉลี่ยต่อวันในเดือน${currentMonthName}คือ <strong>${hoursToTimeString(avgUpTimeLatest)}</strong> เทียบกับเดือน${thaiMonths[previousMonth-1]}ที่ใช้เวลาเฉลี่ย <strong>${hoursToTimeString(avgUpTimePrevious)}</strong></p><p class="mt-2 ${improvement >= 0 ? 'text-green-600' : 'text-red-600'} font-semibold">สรุป: ใช้เวลาคัดไข่จริงเฉลี่ยเร็วขึ้น ${improvement.toFixed(2)}%</p><p class="mt-2 text-sm text-slate-500">หมายเหตุ: การคำนวณนี้อ้างอิงจาก "Up Time" ซึ่งเป็นเวลาที่เครื่องจักรทำงานคัดไข่จริงๆ ไม่รวมเวลาหยุด</p>`;
        }

        // --- INITIAL RENDER ---
        document.addEventListener('DOMContentLoaded', fetchDataAndRender);
    </script>
</body>
</html>


